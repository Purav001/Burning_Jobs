# 19. Create User Profile Page

1. app/api/auth/profile/route.ts

   ```ts
   import { auth } from '@/lib/auth'
   import dbConnect from '@/lib/dbConnect'
   import UserModel from '@/lib/models/UserModel'
   import bcrypt from 'bcryptjs'

   export const PUT = auth(async (req) => {
     if (!req.auth) {
       return Response.json({ message: 'Not authenticated' }, { status: 401 })
     }
     const { user } = req.auth
     const { name, email, password } = await req.json()
     await dbConnect()

     try {
       const dbUser = await UserModel.findById(user._id)
       if (!dbUser) {
         return Response.json(
           { message: 'User not found' },
           {
             status: 404,
           }
         )
       }
       dbUser.name = name
       dbUser.email = email
       dbUser.password = password
         ? await bcrypt.hash(password, 5)
         : dbUser.password
       await dbUser.save()
       return Response.json({ message: 'User has been updated' })
     } catch (err: any) {
       return Response.json(
         { message: err.message },
         {
           status: 500,
         }
       )
     }
   })
   ```

2. components/header/Menu.tsx

   ```ts
   <li onClick={handleClick}>
     <Link href="/profile">Profile</Link>
   </li>
   ```

3. app/(front)/profile/Form.tsx

   ```ts
   'use client'
   import { useEffect } from 'react'
   import toast from 'react-hot-toast'
   import { useRouter } from 'next/navigation'
   import { useSession } from 'next-auth/react'
   import { useForm, SubmitHandler } from 'react-hook-form'
   import { getError } from '@/lib/utils'

   type Inputs = {
     name: string
     email: string
     password: string
     confirmPassword: string
   }

   const Form = () => {
     const { data: session, update } = useSession()
     const router = useRouter()

     const {
       register,
       handleSubmit,
       getValues,
       setValue,
       formState: { errors, isSubmitting },
     } = useForm<Inputs>({
       defaultValues: {
         email: '',
         password: '',
       },
     })

     useEffect(() => {
       if (session && session.user) {
         setValue('name', session.user.name!)
         setValue('email', session.user.email!)
       }
     }, [router, session, setValue])

     const formSubmit: SubmitHandler<Inputs> = async (form) => {
       const { name, email, password } = form

       try {
         const res = await fetch('/api/auth/profile', {
           method: 'PUT',
           headers: {
             'Content-Type': 'application/json',
           },
           body: JSON.stringify({
             name,
             email,
             password,
           }),
         })
         if (res.status === 200) {
           toast.success('Profile updated successfully')
           const newSession = {
             ...session,
             user: {
               ...session?.user,
               name,
               email,
             },
           }
           await update(newSession)
         } else {
           const data = await res.json()
           toast.error(data.message || 'error')
         }
       } catch (err: any) {
         const error =
           err.response && err.response.data && err.response.data.message
             ? err.response.data.message
             : err.message
         toast.error(error)
       }
     }
     return (
       <div className="max-w-sm  mx-auto card bg-base-300 my-4">
         <div className="card-body">
           <h1 className="card-title">Profile</h1>
           <form onSubmit={handleSubmit(formSubmit)}>
             <div className="my-2">
               <label className="label" htmlFor="name">
                 Name
               </label>
               <input
                 type="text"
                 id="name"
                 {...register('name', {
                   required: 'Name is required',
                 })}
                 className="input input-bordered w-full max-w-sm"
               />
               {errors.name?.message && (
                 <div className="text-error">{errors.name.message}</div>
               )}
             </div>
             <div className="my-2">
               <label className="label" htmlFor="email">
                 Email
               </label>
               <input
                 type="text"
                 id="email"
                 {...register('email', {
                   required: 'Email is required',
                   pattern: {
                     value: /[a-z0-9]+@[a-z]+\.[a-z]{2,3}/,
                     message: 'Email is invalid',
                   },
                 })}
                 className="input input-bordered w-full max-w-sm"
               />
               {errors.email?.message && (
                 <div className="text-error">{errors.email.message}</div>
               )}
             </div>
             <div className="my-2">
               <label className="label" htmlFor="password">
                 New Password
               </label>
               <input
                 type="password"
                 id="password"
                 {...register('password', {})}
                 className="input input-bordered w-full max-w-sm"
               />
               {errors.password?.message && (
                 <div className="text-error">{errors.password.message}</div>
               )}
             </div>
             <div className="my-2">
               <label className="label" htmlFor="confirmPassword">
                 Confirm New Password
               </label>
               <input
                 type="password"
                 id="confirmPassword"
                 {...register('confirmPassword', {
                   validate: (value) => {
                     const { password } = getValues()
                     return password === value || 'Passwords should match!'
                   },
                 })}
                 className="input input-bordered w-full max-w-sm"
               />
               {errors.confirmPassword?.message && (
                 <div className="text-error">
                   {errors.confirmPassword.message}
                 </div>
               )}
             </div>
             <div className="my-2">
               <button
                 type="submit"
                 disabled={isSubmitting}
                 className="btn btn-primary w-full"
               >
                 {isSubmitting && (
                   <span className="loading loading-spinner"></span>
                 )}
                 Update
               </button>
             </div>
           </form>
         </div>
       </div>
     )
   }

   export default Form
   ```

4. app/(front)/profile/page.tsx

   ```ts
   import { Metadata } from 'next'
   import Form from './Form'

   export const metadata: Metadata = {
     title: 'Profile',
   }

   export default async function Profile() {
     return <Form />
   }
   ```
